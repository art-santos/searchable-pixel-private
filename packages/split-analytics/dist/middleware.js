"use strict";var h=Object.defineProperty;var v=Object.getOwnPropertyDescriptor;var R=Object.getOwnPropertyNames;var S=Object.prototype.hasOwnProperty;var B=(r,e)=>{for(var t in e)h(r,t,{get:e[t],enumerable:!0})},M=(r,e,t,a)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of R(e))!S.call(r,n)&&n!==t&&h(r,n,{get:()=>e[n],enumerable:!(a=v(e,n))||a.enumerable});return r};var k=r=>M(h({},"__esModule",{value:!0}),r);var P={};B(P,{createCrawlerMiddleware:()=>_,destroyTracker:()=>D});module.exports=k(P);var l=require("next/server");var g={GPTBot:{company:"OpenAI",bot:"GPTBot",category:"ai-training"},"ChatGPT-User":{company:"OpenAI",bot:"ChatGPT-User",category:"ai-assistant"},CCBot:{company:"Common Crawl",bot:"CCBot",category:"ai-training"},"Claude-Web":{company:"Anthropic",bot:"Claude-Web",category:"ai-assistant"},ClaudeBot:{company:"Anthropic",bot:"ClaudeBot",category:"ai-training"},"Google-Extended":{company:"Google",bot:"Google-Extended",category:"ai-training"},Googlebot:{company:"Google",bot:"Googlebot",category:"search-ai"},Bingbot:{company:"Microsoft",bot:"Bingbot",category:"search-ai"},PerplexityBot:{company:"Perplexity",bot:"PerplexityBot",category:"ai-search"},YouBot:{company:"You.com",bot:"YouBot",category:"ai-search"},Bytespider:{company:"ByteDance",bot:"Bytespider",category:"ai-training"},Diffbot:{company:"Diffbot",bot:"Diffbot",category:"ai-extraction"},FacebookBot:{company:"Meta",bot:"FacebookBot",category:"social-ai"},facebookexternalhit:{company:"Meta",bot:"facebookexternalhit",category:"social-ai"},Amazonbot:{company:"Amazon",bot:"Amazonbot",category:"ai-assistant"},Applebot:{company:"Apple",bot:"Applebot",category:"search-ai"}},f="https://split.dev/api/crawler-events",m=10,y=5e3,w=3,C=1e3;function b(r){if(!r)return{isAICrawler:!1,userAgent:""};for(let[a,n]of Object.entries(g))if(r.includes(a))return{isAICrawler:!0,crawler:n,userAgent:r};let e=r.toLowerCase(),t=["ai-crawler","ai-bot","llm-crawler","training-bot","ml-bot"];for(let a of t)if(e.includes(a))return{isAICrawler:!0,crawler:{company:"Unknown",bot:a,category:"unknown"},userAgent:r};return{isAICrawler:!1,userAgent:r}}function A(r){let e={},t=r.headers.referer||r.headers.referrer;t&&(e.referer=Array.isArray(t)?t[0]:t);let a=r.headers.accept;a&&(e.accept=Array.isArray(a)?a.join(", "):a);let n=r.headers["accept-encoding"];n&&(e.acceptEncoding=Array.isArray(n)?n.join(", "):n);let i=r.headers["accept-language"];return i&&(e.acceptLanguage=Array.isArray(i)?i[0]:i),e}var u=class{constructor(e){this.eventQueue=[];this.batchTimer=null;this.isSending=!1;this.config={apiKey:e.apiKey,apiEndpoint:e.apiEndpoint||f,batchSize:e.batchSize||m,batchIntervalMs:e.batchIntervalMs||y,debug:e.debug||!1,onError:e.onError||(t=>console.error("[Split Analytics]",t))}}async track(e){let t={...e,timestamp:new Date().toISOString()};this.eventQueue.push(t),this.config.debug&&console.log("[Split Analytics] Event queued:",t),this.eventQueue.length>=this.config.batchSize?await this.flush():this.scheduleBatch()}createEvent(e,t,a){let n=new URL(t.url);return{domain:n.hostname,path:n.pathname,crawlerName:e.bot,crawlerCompany:e.company,crawlerCategory:e.category,userAgent:this.getHeaderValue(t.headers["user-agent"])||"",statusCode:t.statusCode,responseTimeMs:t.responseTimeMs,metadata:a}}scheduleBatch(){this.batchTimer||(this.batchTimer=setTimeout(async()=>{this.batchTimer=null,this.eventQueue.length>0&&await this.flush()},this.config.batchIntervalMs))}async flush(){if(this.isSending||this.eventQueue.length===0)return;this.isSending=!0;let e=[...this.eventQueue];this.eventQueue=[];try{await this.sendBatch(e)}catch(t){this.eventQueue.unshift(...e),this.config.onError(t)}finally{this.isSending=!1}}async sendBatch(e,t=1){try{let a=await fetch(this.config.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.apiKey}`,"X-Split-Version":"0.1.0"},body:JSON.stringify({events:e})});if(!a.ok)throw new Error(`API error: ${a.status} ${a.statusText}`);this.config.debug&&console.log(`[Split Analytics] Sent ${e.length} events`)}catch(a){if(t<w){let n=C*Math.pow(2,t-1);return this.config.debug&&console.log(`[Split Analytics] Retry attempt ${t} after ${n}ms`),await new Promise(i=>setTimeout(i,n)),this.sendBatch(e,t+1)}throw a}}getHeaderValue(e){if(e)return Array.isArray(e)?e[0]:e}destroy(){this.batchTimer&&(clearTimeout(this.batchTimer),this.batchTimer=null),this.flush().catch(()=>{})}};var o=null;function _(r){return o||(o=new u(r)),async function(t){let a=Date.now();try{let n=t.nextUrl.pathname;if(r.exclude&&r.exclude.some(s=>s.includes("*")?new RegExp(s.replace(/\*/g,".*")).test(n):n.startsWith(s)))return l.NextResponse.next();if(r.include&&!r.include.some(s=>s.includes("*")?new RegExp(s.replace(/\*/g,".*")).test(n):n.startsWith(s)))return l.NextResponse.next();let i=t.headers.get("user-agent"),c=b(i);if(!c.isAICrawler||!c.crawler)return l.NextResponse.next();r.onCrawlerDetected&&await r.onCrawlerDetected(t,c.crawler);let d=l.NextResponse.next();r.addCrawlerHeaders&&(d.headers.set("X-AI-Crawler-Detected","true"),d.headers.set("X-AI-Crawler-Name",c.crawler.bot),d.headers.set("X-AI-Crawler-Company",c.crawler.company));let T=A({headers:Object.fromEntries(t.headers.entries()),url:t.url,method:t.method}),x=Date.now()-a;o||(o=new u(r));let E=o.createEvent(c.crawler,{url:t.url,headers:Object.fromEntries(t.headers.entries()),statusCode:d.status,responseTimeMs:x},T);return o.track(E).catch(p=>{r.debug&&console.error("[Split Analytics] Failed to track event:",p)}),d}catch(n){return r.debug&&console.error("[Split Analytics] Middleware error:",n),l.NextResponse.next()}}}function D(){o&&(o.destroy(),o=null)}0&&(module.exports={createCrawlerMiddleware,destroyTracker});
//# sourceMappingURL=middleware.js.map