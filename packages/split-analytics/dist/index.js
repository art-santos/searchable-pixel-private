"use strict";var d=Object.defineProperty;var R=Object.getOwnPropertyDescriptor;var S=Object.getOwnPropertyNames;var x=Object.prototype.hasOwnProperty;var M=(n,e)=>{for(var t in e)d(n,t,{get:e[t],enumerable:!0})},k=(n,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of S(e))!x.call(n,a)&&a!==t&&d(n,a,{get:()=>e[a],enumerable:!(r=R(e,a))||r.enumerable});return n};var B=n=>k(d({},"__esModule",{value:!0}),n);var D={};M(D,{AI_CRAWLERS:()=>l,CrawlerTracker:()=>i,createNodeMiddleware:()=>_,detectAICrawler:()=>s,extractRequestMetadata:()=>c,trackCrawler:()=>P});module.exports=B(D);var l={GPTBot:{company:"OpenAI",bot:"GPTBot",category:"ai-training"},"ChatGPT-User":{company:"OpenAI",bot:"ChatGPT-User",category:"ai-assistant"},CCBot:{company:"Common Crawl",bot:"CCBot",category:"ai-training"},"Claude-Web":{company:"Anthropic",bot:"Claude-Web",category:"ai-assistant"},ClaudeBot:{company:"Anthropic",bot:"ClaudeBot",category:"ai-training"},"Google-Extended":{company:"Google",bot:"Google-Extended",category:"ai-training"},Googlebot:{company:"Google",bot:"Googlebot",category:"search-ai"},Bingbot:{company:"Microsoft",bot:"Bingbot",category:"search-ai"},PerplexityBot:{company:"Perplexity",bot:"PerplexityBot",category:"ai-search"},YouBot:{company:"You.com",bot:"YouBot",category:"ai-search"},Bytespider:{company:"ByteDance",bot:"Bytespider",category:"ai-training"},Diffbot:{company:"Diffbot",bot:"Diffbot",category:"ai-extraction"},FacebookBot:{company:"Meta",bot:"FacebookBot",category:"social-ai"},facebookexternalhit:{company:"Meta",bot:"facebookexternalhit",category:"social-ai"},Amazonbot:{company:"Amazon",bot:"Amazonbot",category:"ai-assistant"},Applebot:{company:"Apple",bot:"Applebot",category:"search-ai"}},u="https://split.dev/api/crawler-events",f=10,h=5e3,m=3,y=1e3;function s(n){if(!n)return{isAICrawler:!1,userAgent:""};for(let[r,a]of Object.entries(l))if(n.includes(r))return{isAICrawler:!0,crawler:a,userAgent:n};let e=n.toLowerCase(),t=["ai-crawler","ai-bot","llm-crawler","training-bot","ml-bot"];for(let r of t)if(e.includes(r))return{isAICrawler:!0,crawler:{company:"Unknown",bot:r,category:"unknown"},userAgent:n};return{isAICrawler:!1,userAgent:n}}function c(n){let e={},t=n.headers.referer||n.headers.referrer;t&&(e.referer=Array.isArray(t)?t[0]:t);let r=n.headers.accept;r&&(e.accept=Array.isArray(r)?r.join(", "):r);let a=n.headers["accept-encoding"];a&&(e.acceptEncoding=Array.isArray(a)?a.join(", "):a);let o=n.headers["accept-language"];return o&&(e.acceptLanguage=Array.isArray(o)?o[0]:o),e}var i=class{constructor(e){this.eventQueue=[];this.batchTimer=null;this.isSending=!1;this.config={apiKey:e.apiKey,apiEndpoint:e.apiEndpoint||u,batchSize:e.batchSize||f,batchIntervalMs:e.batchIntervalMs||h,debug:e.debug||!1,onError:e.onError||(t=>console.error("[Split Analytics]",t))}}async track(e){let t={...e,timestamp:new Date().toISOString()};this.eventQueue.push(t),this.config.debug&&console.log("[Split Analytics] Event queued:",t),this.eventQueue.length>=this.config.batchSize?await this.flush():this.scheduleBatch()}createEvent(e,t,r){let a=new URL(t.url);return{domain:a.hostname,path:a.pathname,crawlerName:e.bot,crawlerCompany:e.company,crawlerCategory:e.category,userAgent:this.getHeaderValue(t.headers["user-agent"])||"",statusCode:t.statusCode,responseTimeMs:t.responseTimeMs,metadata:r}}scheduleBatch(){this.batchTimer||(this.batchTimer=setTimeout(async()=>{this.batchTimer=null,this.eventQueue.length>0&&await this.flush()},this.config.batchIntervalMs))}async flush(){if(this.isSending||this.eventQueue.length===0)return;this.isSending=!0;let e=[...this.eventQueue];this.eventQueue=[];try{await this.sendBatch(e)}catch(t){this.eventQueue.unshift(...e),this.config.onError(t)}finally{this.isSending=!1}}async sendBatch(e,t=1){try{let r=await fetch(this.config.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.apiKey}`,"X-Split-Version":"0.1.0"},body:JSON.stringify({events:e})});if(!r.ok)throw new Error(`API error: ${r.status} ${r.statusText}`);this.config.debug&&console.log(`[Split Analytics] Sent ${e.length} events`)}catch(r){if(t<m){let a=y*Math.pow(2,t-1);return this.config.debug&&console.log(`[Split Analytics] Retry attempt ${t} after ${a}ms`),await new Promise(o=>setTimeout(o,a)),this.sendBatch(e,t+1)}throw r}}getHeaderValue(e){if(e)return Array.isArray(e)?e[0]:e}destroy(){this.batchTimer&&(clearTimeout(this.batchTimer),this.batchTimer=null),this.flush().catch(()=>{})}};function _(n){let e=new i(n);return function(r,a,o){let w=Date.now();try{let p=r.headers["user-agent"]||"",g=s(p);if(!g.isAICrawler||!g.crawler)return o();let C=g.crawler,b=a.end;a.end=function(...A){let T=Date.now()-w,E=`${r.headers.host}${r.url}`,I=e.createEvent(C,{url:E,headers:r.headers,statusCode:a.statusCode,responseTimeMs:T},c({headers:r.headers}));return e.track(I).catch(v=>{n.debug&&console.error("[Split Analytics] Failed to track event:",v)}),b.apply(this,A)},o()}catch(p){n.debug&&console.error("[Split Analytics] Middleware error:",p),o()}}}async function P(n,e){let t=s(e.userAgent);if(!t.isAICrawler||!t.crawler)return!1;let r=new i(n),a=r.createEvent(t.crawler,{url:e.url,headers:{"user-agent":e.userAgent,...e.headers||{}},statusCode:e.statusCode,responseTimeMs:e.responseTimeMs},e.headers?c({headers:e.headers}):void 0);return await r.track(a),r.destroy(),!0}0&&(module.exports={AI_CRAWLERS,CrawlerTracker,createNodeMiddleware,detectAICrawler,extractRequestMetadata,trackCrawler});
//# sourceMappingURL=index.js.map