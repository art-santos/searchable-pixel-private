<<<<<<< HEAD
import{NextResponse as p}from"next/server";var u={GPTBot:{company:"OpenAI",bot:"GPTBot",category:"ai-training"},"ChatGPT-User":{company:"OpenAI",bot:"ChatGPT-User",category:"ai-assistant"},"OAI-SearchBot":{company:"OpenAI",bot:"OAI-SearchBot",category:"ai-search"},"Claude-Web":{company:"Anthropic",bot:"Claude-Web",category:"ai-assistant"},ClaudeBot:{company:"Anthropic",bot:"ClaudeBot",category:"ai-training"},"anthropic-ai":{company:"Anthropic",bot:"anthropic-ai",category:"ai-training"},"Google-Extended":{company:"Google",bot:"Google-Extended",category:"ai-training"},Googlebot:{company:"Google",bot:"Googlebot",category:"search-ai"},"Googlebot-Image":{company:"Google",bot:"Googlebot-Image",category:"search-ai"},"Googlebot-News":{company:"Google",bot:"Googlebot-News",category:"search-ai"},"Google-InspectionTool":{company:"Google",bot:"Google-InspectionTool",category:"search-ai"},Bingbot:{company:"Microsoft",bot:"Bingbot",category:"search-ai"},msnbot:{company:"Microsoft",bot:"msnbot",category:"search-ai"},BingPreview:{company:"Microsoft",bot:"BingPreview",category:"search-ai"},PerplexityBot:{company:"Perplexity",bot:"PerplexityBot",category:"ai-search"},FacebookBot:{company:"Meta",bot:"FacebookBot",category:"social-ai"},facebookexternalhit:{company:"Meta",bot:"facebookexternalhit",category:"social-ai"},"Meta-ExternalAgent":{company:"Meta",bot:"Meta-ExternalAgent",category:"ai-training"},YouBot:{company:"You.com",bot:"YouBot",category:"ai-search"},Neeva:{company:"Neeva",bot:"Neeva",category:"ai-search"},Phind:{company:"Phind",bot:"Phind",category:"ai-search"},Bytespider:{company:"ByteDance",bot:"Bytespider",category:"ai-training"},Baiduspider:{company:"Baidu",bot:"Baiduspider",category:"search-ai"},Sogou:{company:"Sogou",bot:"Sogou",category:"search-ai"},Amazonbot:{company:"Amazon",bot:"Amazonbot",category:"ai-assistant"},LinkedInBot:{company:"LinkedIn",bot:"LinkedInBot",category:"social-ai"},Twitterbot:{company:"Twitter",bot:"Twitterbot",category:"social-ai"},Applebot:{company:"Apple",bot:"Applebot",category:"search-ai"},"Applebot-Extended":{company:"Apple",bot:"Applebot-Extended",category:"ai-training"},Diffbot:{company:"Diffbot",bot:"Diffbot",category:"ai-extraction"},DataForSeoBot:{company:"DataForSEO",bot:"DataForSeoBot",category:"ai-extraction"},SemrushBot:{company:"Semrush",bot:"SemrushBot",category:"ai-extraction"},AhrefsBot:{company:"Ahrefs",bot:"AhrefsBot",category:"ai-extraction"},CCBot:{company:"Common Crawl",bot:"CCBot",category:"ai-training"},ia_archiver:{company:"Internet Archive",bot:"ia_archiver",category:"archival"},PetalBot:{company:"Petal Search",bot:"PetalBot",category:"search-ai"},SeznamBot:{company:"Seznam",bot:"SeznamBot",category:"search-ai"},Yandex:{company:"Yandex",bot:"YandexBot",category:"search-ai"},DuckDuckBot:{company:"DuckDuckGo",bot:"DuckDuckBot",category:"search-ai"},Qwantify:{company:"Qwant",bot:"Qwantify",category:"search-ai"}},h="https://split.dev/api/crawler-events",y=10,m=5e3,f=3,b=1e3;function w(r){if(!r)return{isAICrawler:!1,userAgent:""};for(let[a,o]of Object.entries(u))if(r.includes(a))return{isAICrawler:!0,crawler:o,userAgent:r};let e=r.toLowerCase(),t=["ai-crawler","ai-bot","llm-crawler","training-bot","ml-bot"];for(let a of t)if(e.includes(a))return{isAICrawler:!0,crawler:{company:"Unknown",bot:a,category:"unknown"},userAgent:r};return{isAICrawler:!1,userAgent:r}}function A(r){let e={},t=r.headers.referer||r.headers.referrer;t&&(e.referer=Array.isArray(t)?t[0]:t);let a=r.headers.accept;a&&(e.accept=Array.isArray(a)?a.join(", "):a);let o=r.headers["accept-encoding"];o&&(e.acceptEncoding=Array.isArray(o)?o.join(", "):o);let i=r.headers["accept-language"];return i&&(e.acceptLanguage=Array.isArray(i)?i[0]:i),e}var g=class{constructor(e){this.eventQueue=[];this.batchTimer=null;this.isSending=!1;this.config={apiKey:e.apiKey,apiEndpoint:e.apiEndpoint||h,batchSize:e.batchSize||y,batchIntervalMs:e.batchIntervalMs||m,debug:e.debug||!1,onError:e.onError||(t=>console.error("[Split Analytics]",t))}}async track(e){let t={...e,timestamp:new Date().toISOString()};this.eventQueue.push(t),this.config.debug&&console.log("[Split Analytics] Event queued:",t),this.eventQueue.length>=this.config.batchSize?await this.flush():this.scheduleBatch()}createEvent(e,t,a){let o=new URL(t.url);return{domain:o.hostname,path:o.pathname,crawlerName:e.bot,crawlerCompany:e.company,crawlerCategory:e.category,userAgent:this.getHeaderValue(t.headers["user-agent"])||"",statusCode:t.statusCode,responseTimeMs:t.responseTimeMs,metadata:a}}scheduleBatch(){this.batchTimer||(this.batchTimer=setTimeout(async()=>{this.batchTimer=null,this.eventQueue.length>0&&await this.flush()},this.config.batchIntervalMs))}async flush(){if(this.isSending||this.eventQueue.length===0)return;this.isSending=!0;let e=[...this.eventQueue];this.eventQueue=[];try{await this.sendBatch(e)}catch(t){this.eventQueue.unshift(...e),this.config.onError(t)}finally{this.isSending=!1}}async sendBatch(e,t=1){try{let a=await fetch(this.config.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.apiKey}`,"X-Split-Version":"0.1.0"},body:JSON.stringify({events:e})});if(!a.ok)throw new Error(`API error: ${a.status} ${a.statusText}`);this.config.debug&&console.log(`[Split Analytics] Sent ${e.length} events`)}catch(a){if(t<f){let o=b*Math.pow(2,t-1);return this.config.debug&&console.log(`[Split Analytics] Retry attempt ${t} after ${o}ms`),await new Promise(i=>setTimeout(i,o)),this.sendBatch(e,t+1)}throw a}}getHeaderValue(e){if(e)return Array.isArray(e)?e[0]:e}destroy(){this.batchTimer&&(clearTimeout(this.batchTimer),this.batchTimer=null),this.flush().catch(()=>{})}async ping(){try{let e=this.config.apiEndpoint.replace(/\/events$/,"/ping"),t=await fetch(e,{method:"GET",headers:{Authorization:`Bearer ${this.config.apiKey}`,"X-Split-Version":"0.1.0"}}),a=await t.json();return t.ok?(this.config.debug&&console.log("[Split Analytics] Ping successful:",a),a):{status:"error",message:a.message||`API error: ${t.status}`}}catch(e){return this.config.debug&&console.error("[Split Analytics] Ping failed:",e),{status:"error",message:e instanceof Error?e.message:"Connection failed"}}}};var n=null;function L(r){return n||(n=new g(r)),async function(t){let a=Date.now();try{let o=t.nextUrl.pathname;if(r.exclude&&r.exclude.some(s=>s.includes("*")?new RegExp(s.replace(/\*/g,".*")).test(o):o.startsWith(s)))return p.next();if(r.include&&!r.include.some(s=>s.includes("*")?new RegExp(s.replace(/\*/g,".*")).test(o):o.startsWith(s)))return p.next();let i=t.headers.get("user-agent"),c=w(i);if(!c.isAICrawler||!c.crawler)return p.next();r.onCrawlerDetected&&await r.onCrawlerDetected(t,c.crawler);let l=p.next();r.addCrawlerHeaders&&(l.headers.set("X-AI-Crawler-Detected","true"),l.headers.set("X-AI-Crawler-Name",c.crawler.bot),l.headers.set("X-AI-Crawler-Company",c.crawler.company));let C=A({headers:Object.fromEntries(t.headers.entries()),url:t.url,method:t.method}),x=Date.now()-a;n||(n=new g(r));let E=n.createEvent(c.crawler,{url:t.url,headers:Object.fromEntries(t.headers.entries()),statusCode:l.status,responseTimeMs:x},C);return n.track(E).catch(d=>{r.debug&&console.error("[Split Analytics] Failed to track event:",d)}),l}catch(o){return r.debug&&console.error("[Split Analytics] Middleware error:",o),p.next()}}}function O(){n&&(n.destroy(),n=null)}export{L as createCrawlerMiddleware,O as destroyTracker};
=======
import{NextResponse as s}from"next/server";var d={GPTBot:{name:"GPTBot",company:"OpenAI",category:"ai-training"},"ChatGPT-User":{name:"ChatGPT-User",company:"OpenAI",category:"ai-assistant"},"OAI-SearchBot":{name:"OAI-SearchBot",company:"OpenAI",category:"ai-search"},"Claude-Web":{name:"Claude-Web",company:"Anthropic",category:"ai-assistant"},ClaudeBot:{name:"ClaudeBot",company:"Anthropic",category:"ai-training"},"anthropic-ai":{name:"anthropic-ai",company:"Anthropic",category:"ai-training"},"Google-Extended":{name:"Google-Extended",company:"Google",category:"ai-training"},Googlebot:{name:"Googlebot",company:"Google",category:"search-ai"},"Googlebot-Image":{name:"Googlebot-Image",company:"Google",category:"search-ai"},"Googlebot-News":{name:"Googlebot-News",company:"Google",category:"search-ai"},Bingbot:{name:"Bingbot",company:"Microsoft",category:"search-ai"},msnbot:{name:"msnbot",company:"Microsoft",category:"search-ai"},BingPreview:{name:"BingPreview",company:"Microsoft",category:"search-ai"},PerplexityBot:{name:"PerplexityBot",company:"Perplexity",category:"ai-search"},FacebookBot:{name:"FacebookBot",company:"Meta",category:"social-ai"},facebookexternalhit:{name:"facebookexternalhit",company:"Meta",category:"social-ai"},"Meta-ExternalAgent":{name:"Meta-ExternalAgent",company:"Meta",category:"ai-training"},YouBot:{name:"YouBot",company:"You.com",category:"ai-search"},Neeva:{name:"Neeva",company:"Neeva",category:"ai-search"},Phind:{name:"Phind",company:"Phind",category:"ai-search"},Bytespider:{name:"Bytespider",company:"ByteDance",category:"ai-training"},Baiduspider:{name:"Baiduspider",company:"Baidu",category:"search-ai"},Sogou:{name:"Sogou",company:"Sogou",category:"search-ai"},Amazonbot:{name:"Amazonbot",company:"Amazon",category:"ai-assistant"},LinkedInBot:{name:"LinkedInBot",company:"LinkedIn",category:"social-ai"},Twitterbot:{name:"Twitterbot",company:"Twitter",category:"social-ai"},Applebot:{name:"Applebot",company:"Apple",category:"search-ai"},"Applebot-Extended":{name:"Applebot-Extended",company:"Apple",category:"ai-training"},Diffbot:{name:"Diffbot",company:"Diffbot",category:"ai-extraction"},DataForSeoBot:{name:"DataForSeoBot",company:"DataForSEO",category:"ai-extraction"},SemrushBot:{name:"SemrushBot",company:"Semrush",category:"ai-extraction"},AhrefsBot:{name:"AhrefsBot",company:"Ahrefs",category:"ai-extraction"},CCBot:{name:"CCBot",company:"Common Crawl",category:"ai-training"},ia_archiver:{name:"ia_archiver",company:"Internet Archive",category:"archival"},PetalBot:{name:"PetalBot",company:"Petal Search",category:"search-ai"},SeznamBot:{name:"SeznamBot",company:"Seznam",category:"search-ai"},Yandex:{name:"YandexBot",company:"Yandex",category:"search-ai"},DuckDuckBot:{name:"DuckDuckBot",company:"DuckDuckGo",category:"search-ai"},Qwantify:{name:"Qwantify",company:"Qwant",category:"search-ai"}};function p(t){if(!t)return null;for(let[e,a]of Object.entries(d))if(t.includes(e))return a;return null}var i=class{constructor(e){if(!e.apiKey)throw new Error("[Split Analytics] API key is required");this.config={apiKey:e.apiKey,apiEndpoint:e.apiEndpoint||"https://split.dev/api",debug:e.debug||!1},this.config.debug&&console.log("[Split Analytics] Initialized")}async ping(){try{let e=await fetch(`${this.config.apiEndpoint}/ping`,{method:"GET",headers:{Authorization:`Bearer ${this.config.apiKey}`,"Content-Type":"application/json"}});if(!e.ok)return{status:"error",message:(await e.json().catch(()=>({message:"Unknown error"}))).message||`HTTP ${e.status}`};let a=await e.json();return this.config.debug&&console.log("[Split Analytics] Ping successful:",a),a}catch(e){let a=e instanceof Error?e.message:"Connection failed";return this.config.debug&&console.error("[Split Analytics] Ping failed:",e),{status:"error",message:a}}}async track(e){try{let a={...e,timestamp:new Date().toISOString()},n=await fetch(`${this.config.apiEndpoint}/crawler-events`,{method:"POST",headers:{Authorization:`Bearer ${this.config.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({events:[a]})});return n.ok?(this.config.debug&&console.log("[Split Analytics] Tracked:",a.crawler?.name||"unknown crawler"),!0):(this.config.debug&&console.error("[Split Analytics] Track failed:",n.status),!1)}catch(a){return this.config.debug&&console.error("[Split Analytics] Track error:",a),!1}}async autoTrack(e){let a=p(e.userAgent);return a?this.track({url:e.url,userAgent:e.userAgent||"",crawler:a,metadata:{method:e.method,statusCode:e.statusCode,responseTime:e.responseTime}}):!1}};function g(t){return p(t)!==null}function m(t){return p(t)}function x(t){let e=new i(t);return async function(n){let{pathname:o}=n.nextUrl,c=n.headers.get("user-agent");if(t.exclude){for(let r of t.exclude)if(o.match(r))return s.next()}if(t.include&&t.include.length>0){let r=!1;for(let l of t.include)if(o.match(l)){r=!0;break}if(!r)return s.next()}if(g(c)){let r=Date.now(),l=s.next(),y=m(c);return y&&e.track({url:n.url,userAgent:c||"",crawler:y,metadata:{method:n.method,pathname:o,responseTime:Date.now()-r}}).catch(u=>{t.debug&&console.error("[Split Analytics] Tracking failed:",u)}),l}return s.next()}}async function B(t,e){let a=t.headers.get("user-agent");if(!g(a))return!1;let n=new i(e),o=m(a);return o?n.track({url:t.url,userAgent:a||"",crawler:o,metadata:{method:t.method,pathname:t.nextUrl.pathname}}):!1}export{x as createSplitMiddleware,B as trackCrawlerVisit};
>>>>>>> 8236b93 (fixed package)
//# sourceMappingURL=middleware.mjs.map